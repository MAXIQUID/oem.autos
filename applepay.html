<script>
  let tapCount = 0;
  const display = document.getElementById("amount");
  const card = document.getElementById("card");
  const finessed = document.getElementById("finessed");
  const faceid = document.getElementById("faceid");

  // Meme sounds
  const baseUrl = "https://www.myinstants.com";
  const sounds = [
    "/media/sounds/applepay.mp3",
    "/media/sounds/among-us-role-reveal-sound.mp3",
    "/media/sounds/vine-boom-sound-effect_KT89XIq.mp3"
  ];

  // Preload audio elements
  const audioElements = sounds.map(src => {
    const audio = new Audio(baseUrl + src);
    audio.preload = "auto";
    return audio;
  });

  // Cancelable animation state
  let amountAnimationId = null;
  let faceidTimeoutId = null;

  function playRandomSound() {
    const audio = audioElements[Math.floor(Math.random() * audioElements.length)];
    audio.currentTime = 0;
    audio.play().catch(()=>{});
  }

  function animateAmount(finalValue) {
    if (amountAnimationId) cancelAnimationFrame(amountAnimationId);
    let current = 0;
    const step = Math.max(0.5, finalValue / 40);

    function tick() {
      current += step;
      if (current >= finalValue) {
        display.textContent = `+$${finalValue.toFixed(2)}`;
        amountAnimationId = null;
        return;
      }
      display.textContent = `+$${current.toFixed(2)}`;
      amountAnimationId = requestAnimationFrame(tick);
    }
    tick();
  }

  document.body.addEventListener("click", () => {
    tapCount++;
    playRandomSound();

    if (navigator.vibrate) navigator.vibrate([50,30,80,30,50]);

    card.classList.add("show");

    // Reset Face ID
    if (faceidTimeoutId) clearTimeout(faceidTimeoutId);
    faceid.classList.remove("show");
    void faceid.offsetWidth;
    faceid.classList.add("show");

    faceidTimeoutId = setTimeout(() => {
      faceid.classList.remove("show");

      const amounts = [4.99, 9.99, 14.50, 19.99, 24.00, 49.99, 79.00, 129.99, 199.00];
      const randomAmount = amounts[Math.floor(Math.random() * amounts.length)];

      // Reset display animation
      display.classList.remove("show");
      void display.offsetWidth;
      display.classList.add("show");
      animateAmount(randomAmount);

      if (tapCount === 5) {
        finessed.classList.add("show");
      }

    }, 1500); // Face ID scan duration
  });
</script>